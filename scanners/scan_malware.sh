#!/bin/bash
# Scan filesystem targets using ClamAV, Maldet and YARA
TARGET="${1:-/var/www}"
LOGDIR="/var/ngosec/logs"
REPORTDIR="/var/ngosec/reports"
mkdir -p "$LOGDIR" "$REPORTDIR"
DATE=$(date +%F_%H%M)

echo "Starting malware scan of $TARGET at $(date)" | tee -a "$LOGDIR/scan_malware_$DATE.log"

# ClamAV
clamscan -ri "$TARGET" --log="$LOGDIR/clamav_$DATE.log"

# Maldet (if installed)
if command -v maldet >/dev/null 2>&1; then
  maldet -a "$TARGET" --report-file "$REPORTDIR/maldet_$DATE.log" || true
fi

# YARA rules (if any)
YARADIR="$(dirname "$0")/yara_rules"
if [ -d "$YARADIR" ]; then
  for rule in "$YARADIR"/*.yar; do
    [ -f "$rule" ] || continue
    yara -r "$rule" "$TARGET" >> "$LOGDIR/yara_$DATE.log" || true
  done
fi

echo "Malware scan complete. Logs: $LOGDIR/clamav_$DATE.log" | tee -a "$LOGDIR/scan_malware_$DATE.log"
